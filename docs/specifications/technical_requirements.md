# 技術要件仕様書

## 1. 機能要件

### 1.1 コア機能

#### 1.1.1 画像セグメンテーション機能
- **要件ID**: REQ-001
- **概要**: YOLOを使用したLive2D用パーツの自動セグメンテーション
- **詳細**:
  - 対応形式: PNG, JPEG, WebP, TIFF
  - 最大サイズ: 4096x4096px
  - 処理時間: 30秒以内/枚
  - 精度: mIoU 0.85以上

#### 1.1.2 Live2D素材生成機能
- **要件ID**: REQ-002
- **概要**: セグメンテーション結果からLive2D用素材を生成
- **詳細**:
  - 透明度処理: フルアルファチャンネル対応
  - レイヤー分離: 最大50層
  - 出力形式: PNG, PSD
  - メッシュ情報: 自動生成

#### 1.1.3 バッチ処理機能
- **要件ID**: REQ-003
- **概要**: 複数画像の一括処理
- **詳細**:
  - 同時処理: 最大10枚
  - キュー管理: FIFO方式
  - 進捗表示: リアルタイム更新
  - 結果一括ダウンロード

### 1.2 UI機能

#### 1.2.1 画像アップロード機能
- **要件ID**: REQ-101
- **概要**: Webベースの画像アップロードインターフェース
- **詳細**:
  - ドラッグ&ドロップ対応
  - 複数ファイル選択
  - プレビュー表示
  - 進捗表示

#### 1.2.2 設定管理機能
- **要件ID**: REQ-102
- **概要**: セグメンテーション・出力設定の管理
- **詳細**:
  - モデル選択
  - 閾値調整
  - 出力形式選択
  - プリセット保存

#### 1.2.3 結果表示・編集機能
- **要件ID**: REQ-103
- **概要**: セグメンテーション結果の表示・編集
- **詳細**:
  - インタラクティブプレビュー
  - マスク編集
  - レイヤー管理
  - 品質確認

### 1.3 データ管理機能

#### 1.3.1 ファイル管理機能
- **要件ID**: REQ-201
- **概要**: アップロード・処理・出力ファイルの管理
- **詳細**:
  - 自動削除: 24時間後
  - 圧縮保存: ZIP形式
  - メタデータ管理
  - 履歴保持

#### 1.3.2 設定保存機能
- **要件ID**: REQ-202
- **概要**: ユーザー設定の永続化
- **詳細**:
  - プリセット管理
  - 履歴保存
  - エクスポート/インポート
  - デフォルト設定

## 2. 非機能要件

### 2.1 パフォーマンス要件

#### 2.1.1 処理性能
- **要件ID**: NFR-001
- **項目**: セグメンテーション処理時間
- **目標値**: 30秒以内/枚
- **測定方法**: 標準的なアニメイラスト（1024x1024px）での測定

#### 2.1.2 同時処理性能
- **要件ID**: NFR-002
- **項目**: 並列処理能力
- **目標値**: 10枚同時処理
- **測定方法**: 同一仕様画像での負荷テスト

#### 2.1.3 応答性能
- **要件ID**: NFR-003
- **項目**: UI応答時間
- **目標値**: 1秒以内
- **測定方法**: ユーザー操作から画面更新までの時間

### 2.2 品質要件

#### 2.2.1 セグメンテーション精度
- **要件ID**: NFR-101
- **項目**: セグメンテーション品質
- **目標値**: mIoU 0.85以上
- **測定方法**: 手動アノテーションとの比較

#### 2.2.2 可用性
- **要件ID**: NFR-102
- **項目**: システム稼働率
- **目標值**: 99%以上
- **測定方法**: 月次稼働時間の測定

#### 2.2.3 信頼性
- **要件ID**: NFR-103
- **項目**: エラー率
- **目標値**: 1%以下
- **測定方法**: 総処理件数に対するエラー件数の割合

### 2.3 セキュリティ要件

#### 2.3.1 入力検証
- **要件ID**: SEC-001
- **概要**: アップロードファイルの検証
- **詳細**:
  - ファイル形式検証
  - サイズ制限（50MB以下）
  - マルウェアスキャン
  - メタデータ除去

#### 2.3.2 データ保護
- **要件ID**: SEC-002
- **概要**: ユーザーデータの保護
- **詳細**:
  - 処理中データの暗号化
  - 一定時間後の自動削除
  - アクセスログの記録
  - データ匿名化

#### 2.3.3 アクセス制御
- **要件ID**: SEC-003
- **概要**: システムアクセスの制御
- **詳細**:
  - レート制限（100リクエスト/分）
  - セッション管理
  - 異常アクセス検知
  - IP制限機能

### 2.4 運用要件

#### 2.4.1 監視要件
- **要件ID**: OPS-001
- **概要**: システム監視・運用
- **詳細**:
  - メトリクス収集（CPU、メモリ、GPU使用率）
  - ログ管理（構造化ログ、レベル別管理）
  - アラート機能（閾値超過時の通知）
  - ダッシュボード表示

#### 2.4.2 バックアップ要件
- **要件ID**: OPS-002
- **概要**: データバックアップ・復旧
- **詳細**:
  - 設定データの日次バックアップ
  - モデルファイルの週次バックアップ
  - 復旧手順の文書化
  - 復旧テストの実施

#### 2.4.3 スケーラビリティ要件
- **要件ID**: OPS-003
- **概要**: システムの拡張性
- **詳細**:
  - 水平スケーリング対応
  - 負荷分散機能
  - 動的リソース調整
  - マイクロサービス化対応

## 3. 技術制約

### 3.1 ハードウェア制約

#### 3.1.1 最小要件
- **CPU**: Intel i5-8400 / AMD Ryzen 5 2600 相当以上
- **メモリ**: 8GB RAM以上
- **ストレージ**: 50GB以上の空き容量
- **GPU**: 任意（CPU処理も対応）

#### 3.1.2 推奨要件
- **CPU**: Intel i7-10700K / AMD Ryzen 7 3700X 相当以上
- **メモリ**: 16GB RAM以上
- **ストレージ**: SSD 100GB以上
- **GPU**: NVIDIA RTX 3060 以上（CUDA 11.8+対応）

### 3.2 ソフトウェア制約

#### 3.2.1 実行環境
- **OS**: Linux (Ubuntu 20.04+) / Windows 10+ / MacOS 12+
- **Python**: 3.9 ~ 3.12
- **uv**: 0.4.0+ (パッケージマネージャー)
- **Docker**: 20.10+ (コンテナ使用時)
- **Web Browser**: Chrome 100+, Firefox 100+, Safari 15+

#### 3.2.2 依存関係
- **PyTorch**: 2.0.0+
- **Ultralytics**: 8.3.0+ (YOLOv11対応)
- **OpenCV**: 4.8.0+
- **Streamlit**: 1.28.0+
- **NumPy**: 1.24.0+
- **Pillow**: 10.0.0+

### 3.3 外部制約

#### 3.3.1 ライセンス制約
- **YOLOv11**: AGPL-3.0（商用利用要ライセンス）
- **PyTorch**: BSD-3-Clause
- **OpenCV**: Apache-2.0
- **Streamlit**: Apache-2.0

#### 3.3.2 データ制約
- **学習データ**: 著作権クリアな画像のみ使用
- **プライバシー**: 個人情報を含む画像の処理制限
- **地域制約**: 一部地域での利用制限を考慮

## 4. インターフェース要件

### 4.1 ユーザーインターフェース

#### 4.1.1 Web UI要件
- **技術**: Streamlit-based
- **レスポンシブデザイン**: 1920x1080 ~ 1366x768対応
- **アクセシビリティ**: WCAG 2.1 AA準拠
- **多言語対応**: 日本語・英語

#### 4.1.2 操作性要件
- **学習コスト**: 初回利用で30分以内に基本操作習得
- **操作効率**: 5枚処理で10分以内（セットアップ含む）
- **エラー対応**: 明確なエラーメッセージと解決案提示

### 4.2 API要件

#### 4.2.1 RESTful API
- **基本認証**: API Key認証
- **レート制限**: 100リクエスト/分/APIキー
- **レスポンス形式**: JSON
- **エラー処理**: HTTPステータスコード準拠

#### 4.2.2 主要エンドポイント
```
POST /api/v1/upload          # 画像アップロード
POST /api/v1/segment         # セグメンテーション実行
GET  /api/v1/status/{job_id} # 処理状況確認
GET  /api/v1/result/{job_id} # 結果取得
POST /api/v1/batch           # バッチ処理
```

### 4.3 ファイルフォーマット要件

#### 4.3.1 入力フォーマット
- **画像**: PNG, JPEG, WebP, TIFF
- **設定**: JSON, YAML
- **バッチ**: ZIP（画像ファイル集合）

#### 4.3.2 出力フォーマット
- **画像**: PNG（透明度対応）
- **レイヤーファイル**: PSD
- **メタデータ**: JSON
- **アーカイブ**: ZIP

## 5. データ要件

### 5.1 データモデル

#### 5.1.1 画像データ
```python
{
    "id": "uuid",
    "filename": "string",
    "size": "integer",
    "dimensions": {"width": "integer", "height": "integer"},
    "format": "string",
    "uploaded_at": "datetime",
    "processed_at": "datetime",
    "status": "enum[pending, processing, completed, failed]"
}
```

#### 5.1.2 セグメンテーション結果
```python
{
    "image_id": "uuid",
    "model_version": "string",
    "classes": ["string"],
    "confidence_scores": ["float"],
    "masks": ["base64_encoded_array"],
    "processing_time": "float",
    "accuracy_metrics": {"miou": "float"}
}
```

#### 5.1.3 Live2D出力データ
```python
{
    "image_id": "uuid",
    "layers": {
        "layer_name": {
            "image_data": "base64_encoded",
            "position": {"x": "integer", "y": "integer"},
            "opacity": "float",
            "blend_mode": "string"
        }
    },
    "mesh_data": {
        "layer_name": {
            "vertices": [{"x": "float", "y": "float"}],
            "triangles": [["integer"]]
        }
    },
    "export_settings": "object"
}
```

### 5.2 データベース要件

#### 5.2.1 メタデータストレージ
- **技術**: SQLite（軽量運用） / PostgreSQL（本格運用）
- **用途**: 画像メタデータ、処理履歴、設定情報
- **パフォーマンス**: 1000件/秒の書き込み性能

#### 5.2.2 ファイルストレージ
- **技術**: ローカルファイルシステム / S3互換ストレージ
- **用途**: 画像ファイル、処理結果、モデルファイル
- **容量**: 初期100GB、年間200GB増加想定

### 5.3 モデルデータ要件

#### 5.3.1 YOLOモデル仕様
- **ベースモデル**: YOLOv11 (最新版)
- **入力サイズ**: 640x640px（正方形リサイズ）
- **出力クラス数**: 20+ Live2Dパーツクラス
- **モデルサイズ**: 100MB以下
- **推論速度**: RTX 3060で10ms以内

#### 5.3.2 学習データ要件
- **画像数**: 最低5000枚（各クラス250枚以上）
- **品質**: 手動検証済みアノテーション
- **多様性**: 複数の絵柄・構図を含む
- **権利関係**: 商用利用可能な画像のみ

## 6. 品質保証要件

### 6.1 テスト要件

#### 6.1.1 単体テスト
- **カバレッジ**: 90%以上
- **対象**: 全ての関数・メソッド
- **自動化**: CI/CDパイプラインに組み込み

#### 6.1.2 統合テスト
- **シナリオ**: 主要な処理フロー全体
- **データ**: 実際の画像を使用
- **環境**: 本番環境と同等の構成

#### 6.1.3 パフォーマンステスト
- **負荷テスト**: 同時100ユーザー
- **ストレステスト**: リソース上限まで
- **持続性テスト**: 24時間連続稼働

### 6.2 品質メトリクス

#### 6.2.1 精度メトリクス
- **mIoU**: 0.85以上
- **Pixel Accuracy**: 0.90以上
- **F1-Score**: 0.85以上（各クラス）

#### 6.2.2 性能メトリクス
- **処理時間**: 30秒以内/枚
- **メモリ使用量**: 8GB以内
- **GPU使用率**: 80%以下

#### 6.2.3 可用性メトリクス  
- **稼働率**: 99%以上
- **MTBF**: 720時間以上
- **MTTR**: 30分以内